steps:

# build the container image
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '-t', '${_CONTAINER_IMAGE}:$SHORT_SHA', '.' ]

# push the container image to Container Registry
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'push', '${_CONTAINER_IMAGE}:$SHORT_SHA' ]

# deploy container image to Cloud Run
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
  entrypoint: gcloud
  args: [
    'run', 'deploy', '${_SERVICE_NAME}',
    '--image', '${_CONTAINER_IMAGE}:$SHORT_SHA',
    '--region', '$LOCATION',
    '--cpu', '${_CPU}',
    '--memory', '${_MEMORY}',
    '--timeout', '${_REQUEST_TIMEOUT}',
    '--min-instances', '${_MIN_INSTANCES}',
    '--max-instances', '${_MAX_INSTANCES}',
    '--cpu-boost',
    '--allow-unauthenticated',
  ]

images:
- '${_CONTAINER_IMAGE}:$SHORT_SHA'
